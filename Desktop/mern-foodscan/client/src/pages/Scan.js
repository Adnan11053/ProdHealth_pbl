import React, { useRef, useState, useEffect } from 'react'; import { BrowserMultiFormatReader } from '@zxing/browser'; import { useNavigate } from 'react-router-dom';
export default function Scan(){ const [barcode,setBarcode]=useState(''); const [scanning,setScanning]=useState(false); const videoRef=useRef(null); const codeReader=useRef(null); const nav=useNavigate();
useEffect(()=>{ codeReader.current = new BrowserMultiFormatReader(); return ()=>{ try{ codeReader.current?.reset(); }catch(e){} const stream = videoRef.current?.srcObject; if(stream) stream.getTracks().forEach(t=>t.stop()); } },[]);
const startCamera = async ()=>{ setScanning(true); try{ const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }}); videoRef.current.srcObject = stream; await videoRef.current.play(); const result = await codeReader.current.decodeFromVideoDevice(null, videoRef.current, (result, err) => { if(result){ setBarcode(result.getText()); codeReader.current.reset(); const s = videoRef.current?.srcObject; if(s) s.getTracks().forEach(t=>t.stop()); setScanning(false); } }); }catch(e){ alert('Camera error: '+e.message); setScanning(false); } };
return (<div className="max-w-4xl mx-auto p-6"><div className="bg-white rounded-2xl p-6 shadow"><h2 className="text-2xl font-bold text-teal-700">Scan Product</h2><div className="mt-4 grid grid-cols-2 gap-6"><div><h3 className="font-semibold">Manual Entry</h3><input className="w-full mt-2 px-3 py-2 border rounded-md" placeholder="Enter barcode" value={barcode} onChange={e=>setBarcode(e.target.value)} /><button className="mt-3 bg-teal-700 text-white px-4 py-2 rounded-md" onClick={()=>nav(`/results/${barcode}`)}>Check</button></div><div><h3 className="font-semibold">Scan with Camera</h3>{!scanning?<button className="mt-2 bg-teal-500 text-white px-4 py-2 rounded-md" onClick={startCamera}>Start Camera</button>:<div className="text-slate-500">Scanningâ€¦</div>}<div className="mt-3 rounded-md overflow-hidden bg-slate-50"><video ref={videoRef} style={{width:'100%',height:260}} muted playsInline></video></div>{barcode && <div className="mt-2">Detected: <strong>{barcode}</strong> <button className="ml-2 px-2 py-1 border rounded-md" onClick={()=>nav(`/results/${barcode}`)}>Open</button></div>}</div></div></div></div>); }
